# å¤§ëŒ“ê¸€ & ëŒ“ê¸€ ì¢‹ì•„ìš” ê¸°ëŠ¥ êµ¬í˜„ ì™„ë£Œ! âœ…

ëŒ€ëŒ“ê¸€(nested comments)ê³¼ ëŒ“ê¸€ ì¢‹ì•„ìš” ê¸°ëŠ¥ì´ ì„±ê³µì ìœ¼ë¡œ êµ¬í˜„ë˜ì—ˆìŠµë‹ˆë‹¤!

---

## ğŸ“‹ **êµ¬í˜„ëœ ê¸°ëŠ¥**

### 1ï¸âƒ£ **ëŒ€ëŒ“ê¸€ (Nested Comments)**
- âœ… ê° ëŒ“ê¸€ í•˜ë‹¨ì— **"è¿”ä¿¡"** ë²„íŠ¼ ì¶”ê°€
- âœ… ë‹µê¸€ì„ í´ë¦­í•˜ë©´ ëŒ€ëŒ“ê¸€ ì…ë ¥ì°½ì´ ë‚˜íƒ€ë‚¨
- âœ… ëŒ€ëŒ“ê¸€ì€ ì™¼ìª½ ì—¬ë°±(indent)ìœ¼ë¡œ ê³„ì¸µ êµ¬ì¡° í‘œì‹œ
- âœ… ìµœëŒ€ **3ë‹¨ê³„ ê¹Šì´**ê¹Œì§€ ì§€ì› (ë¬´í•œ ì¤‘ì²© ë°©ì§€)
- âœ… íˆ¬ê³ ìê°€ ëŒ€ëŒ“ê¸€ì„ ë‹¬ë©´ **[ä¸»]** íƒœê·¸ í‘œì‹œ
- âœ… ëŒ€ëŒ“ê¸€ ì‘ì„± ì‹œ ì› ê²Œì‹œê¸€ì˜ ë‹‰ë„¤ì„ ìë™ ì ìš© (íˆ¬ê³ ìì¼ ê²½ìš°)

### 2ï¸âƒ£ **ëŒ“ê¸€ ì¢‹ì•„ìš” (Comment Likes)**
- âœ… ê° ëŒ“ê¸€ ì˜†ì— **"ğŸ‘ ã„ã„ã­"** ë²„íŠ¼ê³¼ ìˆ«ì í‘œì‹œ
- âœ… ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥´ë©´ ì‹¤ì‹œê°„ìœ¼ë¡œ ìˆ«ì ì¦ê°€
- âœ… ë‹¤ì‹œ ëˆ„ë¥´ë©´ ì·¨ì†Œë˜ëŠ” **í† ê¸€ ë°©ì‹**
- âœ… ë¡œê·¸ì¸í•˜ì§€ ì•Šìœ¼ë©´ ì¸ì¦ ëª¨ë‹¬ í‘œì‹œ
- âœ… **Optimistic UI Update**: ë²„íŠ¼ í´ë¦­ ì¦‰ì‹œ UI ë°˜ì˜, ì—ëŸ¬ ì‹œ ë¡¤ë°±

### 3ï¸âƒ£ **ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ**
- âœ… `comments` í…Œì´ë¸”ì— `parent_id` ì»¬ëŸ¼ ì¶”ê°€ (self-reference)
- âœ… `comments` í…Œì´ë¸”ì— `likes_count` ì»¬ëŸ¼ ì¶”ê°€ (ì„±ëŠ¥ ìµœì í™”)
- âœ… `comment_likes` í…Œì´ë¸” ìƒì„± (id, comment_id, user_id, created_at)
- âœ… **Unique ì œì•½ ì¡°ê±´**: í•œ ìœ ì €ê°€ í•œ ëŒ“ê¸€ì— ì¢‹ì•„ìš”ë¥¼ í•œ ë²ˆë§Œ ëˆ„ë¥¼ ìˆ˜ ìˆìŒ
- âœ… **RLS ì •ì±…** ì„¤ì •: ì¸ì¦ëœ ì‚¬ìš©ìë§Œ ì¢‹ì•„ìš” ì¶”ê°€/ì‚­ì œ ê°€ëŠ¥
- âœ… **Trigger í•¨ìˆ˜**: ì¢‹ì•„ìš” ì¶”ê°€/ì‚­ì œ ì‹œ ìë™ìœ¼ë¡œ `likes_count` ì—…ë°ì´íŠ¸

---

## ğŸš€ **ì„¤ì¹˜ ë° ì‹¤í–‰ ë°©ë²•**

### **Step 1: Supabase ìŠ¤í‚¤ë§ˆ ì‹¤í–‰**

1. **Supabase Dashboard** ì ‘ì†
   - `https://supabase.com/dashboard` â†’ í”„ë¡œì íŠ¸ ì„ íƒ

2. **SQL Editor** ì—´ê¸°
   - ì¢Œì¸¡ ë©”ë‰´ì—ì„œ **"SQL Editor"** í´ë¦­

3. **New query** í´ë¦­

4. **ìŠ¤í‚¤ë§ˆ ë³µì‚¬ & ì‹¤í–‰**
   - `supabase_nested_comments.sql` íŒŒì¼ ë‚´ìš© **ì „ì²´ ë³µì‚¬**
   - SQL Editorì— ë¶™ì—¬ë„£ê¸°
   - **"Run"** ë²„íŠ¼ í´ë¦­ âœ…

5. **í™•ì¸**
   - ì—ëŸ¬ ì—†ì´ ì™„ë£Œë˜ë©´ ì„±ê³µ!
   - í…Œì´ë¸” í™•ì¸:
     - `comments` í…Œì´ë¸”ì— `parent_id`, `likes_count` ì»¬ëŸ¼ ì¶”ê°€ë¨
     - `comment_likes` í…Œì´ë¸” ìƒì„±ë¨

---

### **Step 2: ë¡œì»¬ ì„œë²„ ì¬ì‹œì‘**

í„°ë¯¸ë„ì—ì„œ ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”:

```bash
# 1. ê¸°ì¡´ ì„œë²„ ì¤‘ì§€ (Ctrl+C)

# 2. Node í”„ë¡œì„¸ìŠ¤ ê°•ì œ ì¢…ë£Œ
pkill -9 node

# 3. ë¹Œë“œ ìºì‹œ ì‚­ì œ
rm -rf .next

# 4. ì„œë²„ ì¬ì‹œì‘
npm run dev
```

---

### **Step 3: í…ŒìŠ¤íŠ¸**

1. **ê²Œì‹œê¸€ ìƒì„¸ í˜ì´ì§€** ì ‘ì†
   - ì•„ë¬´ ê²Œì‹œê¸€ì´ë‚˜ í´ë¦­

2. **ëŒ“ê¸€ ì‘ì„±**
   - ëŒ“ê¸€ ì…ë ¥ í›„ **"æŠ•ç¨¿"** ë²„íŠ¼ í´ë¦­

3. **ëŒ“ê¸€ ì¢‹ì•„ìš” í…ŒìŠ¤íŠ¸**
   - ëŒ“ê¸€ ì˜†ì˜ **"ğŸ‘ ã„ã„ã­"** ë²„íŠ¼ í´ë¦­
   - ìˆ«ìê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ ì¦ê°€í•˜ëŠ”ì§€ í™•ì¸
   - ë‹¤ì‹œ í´ë¦­í•˜ë©´ ì·¨ì†Œë˜ëŠ”ì§€ í™•ì¸

4. **ëŒ€ëŒ“ê¸€ í…ŒìŠ¤íŠ¸**
   - ëŒ“ê¸€ í•˜ë‹¨ì˜ **"è¿”ä¿¡"** ë²„íŠ¼ í´ë¦­
   - ëŒ€ëŒ“ê¸€ ì…ë ¥ì°½ì´ ë‚˜íƒ€ë‚˜ëŠ”ì§€ í™•ì¸
   - ëŒ€ëŒ“ê¸€ ì‘ì„± í›„ **"è¿”ä¿¡"** ë²„íŠ¼ í´ë¦­
   - ì™¼ìª½ ì—¬ë°±ìœ¼ë¡œ ê³„ì¸µ êµ¬ì¡°ê°€ í‘œì‹œë˜ëŠ”ì§€ í™•ì¸

5. **íˆ¬ê³ ì íƒœê·¸ í™•ì¸**
   - ê²Œì‹œê¸€ ì‘ì„±ìê°€ ëŒ“ê¸€/ëŒ€ëŒ“ê¸€ì„ ë‹¬ë©´ **[ä¸»]** íƒœê·¸ê°€ í‘œì‹œë˜ëŠ”ì§€ í™•ì¸

---

## ğŸ“ **ìƒì„±ëœ íŒŒì¼**

### 1. **`supabase_nested_comments.sql`**
   - Supabase ìŠ¤í‚¤ë§ˆ ì—…ë°ì´íŠ¸ SQL
   - `comments` í…Œì´ë¸”ì— `parent_id`, `likes_count` ì¶”ê°€
   - `comment_likes` í…Œì´ë¸” ìƒì„±
   - RLS ì •ì±… ì„¤ì •
   - Trigger í•¨ìˆ˜ ìƒì„±

### 2. **`src/features/posts/hooks/useCommentLike.ts`**
   - ëŒ“ê¸€ ì¢‹ì•„ìš” ê´€ë¦¬ Hook
   - `toggleLike()`: ì¢‹ì•„ìš” í† ê¸€ (ì¶”ê°€/ì‚­ì œ)
   - `likesCount`, `isLiked`, `isLoading` ìƒíƒœ ì œê³µ
   - Optimistic UI Update ì§€ì›

### 3. **`src/features/posts/components/CommentItem.tsx`**
   - ëŒ“ê¸€/ëŒ€ëŒ“ê¸€ UI ì»´í¬ë„ŒíŠ¸
   - ë‹µê¸€ ë²„íŠ¼ & ì…ë ¥ì°½
   - ì¢‹ì•„ìš” ë²„íŠ¼ & ìˆ«ì í‘œì‹œ
   - ì¬ê·€ì ìœ¼ë¡œ ëŒ€ëŒ“ê¸€ ë Œë”ë§ (ìµœëŒ€ 3ë‹¨ê³„)
   - íˆ¬ê³ ì íƒœê·¸ í‘œì‹œ

### 4. **ì—…ë°ì´íŠ¸ëœ íŒŒì¼**
   - `src/features/posts/hooks/useComments.ts`
     - `Comment` ì¸í„°í˜ì´ìŠ¤ì— `parent_id`, `likes_count`, `replies` ì¶”ê°€
     - `createComment()` í•¨ìˆ˜ì— `parent_id` ë§¤ê°œë³€ìˆ˜ ì¶”ê°€
     - ëŒ€ëŒ“ê¸€ì„ nested êµ¬ì¡°ë¡œ ë³€í™˜í•˜ëŠ” ë¡œì§ ì¶”ê°€
   - `src/app/posts/[id]/page.tsx`
     - `CommentItem` ì»´í¬ë„ŒíŠ¸ import & ì‚¬ìš©
     - ëŒ€ëŒ“ê¸€ ì „ì†¡ í•¸ë“¤ëŸ¬ ì¶”ê°€

---

## ğŸ”§ **RLS ì •ì±… (Row Level Security)**

### **`comment_likes` í…Œì´ë¸” RLS**

| ì •ì±… ì´ë¦„ | íƒ€ì… | ê¶Œí•œ | ì¡°ê±´ |
|----------|------|------|------|
| `Comment likes are viewable by everyone` | SELECT | ëª¨ë‘ | ëˆ„êµ¬ë‚˜ ì¡°íšŒ ê°€ëŠ¥ |
| `Authenticated users can insert comment likes` | INSERT | ì¸ì¦ëœ ì‚¬ìš©ì | `auth.uid() = user_id` |
| `Users can delete own comment likes` | DELETE | ì¸ì¦ëœ ì‚¬ìš©ì | `auth.uid() = user_id` |

### **`comments` í…Œì´ë¸” RLS** (ê¸°ì¡´ ì •ì±… í™•ì¸)

| ì •ì±… ì´ë¦„ | íƒ€ì… | ê¶Œí•œ | ì¡°ê±´ |
|----------|------|------|------|
| `Comments are viewable by everyone` | SELECT | ëª¨ë‘ | ëˆ„êµ¬ë‚˜ ì¡°íšŒ ê°€ëŠ¥ |
| `Authenticated users can insert comments` | INSERT | ì¸ì¦ëœ ì‚¬ìš©ì | `auth.uid() = user_id` |
| `Users can update own comments` | UPDATE | ì¸ì¦ëœ ì‚¬ìš©ì | `auth.uid() = user_id` |
| `Users can delete own comments` | DELETE | ì¸ì¦ëœ ì‚¬ìš©ì | `auth.uid() = user_id` |

---

## ğŸ’¡ **ì£¼ìš” ê¸°ëŠ¥ ì„¤ëª…**

### **1. Nested Comments êµ¬ì¡°**

```typescript
// ì˜ˆì‹œ:
Comment 1 (parent_id = null)
  â”œâ”€ Reply 1-1 (parent_id = Comment 1.id)
  â””â”€ Reply 1-2 (parent_id = Comment 1.id)
      â””â”€ Reply 1-2-1 (parent_id = Reply 1-2.id)
```

- `parent_id`ê°€ `null`ì¸ ëŒ“ê¸€ = ìµœìƒìœ„ ëŒ“ê¸€
- `parent_id`ê°€ ìˆëŠ” ëŒ“ê¸€ = ëŒ€ëŒ“ê¸€
- `useComments` í›…ì—ì„œ ìë™ìœ¼ë¡œ nested êµ¬ì¡°ë¡œ ë³€í™˜

### **2. Optimistic UI Update**

```typescript
// ì¢‹ì•„ìš” ë²„íŠ¼ í´ë¦­ ì‹œ:
1. ì¦‰ì‹œ UI ì—…ë°ì´íŠ¸ (isLiked í† ê¸€, likesCount ì¦ê°)
2. Supabase API í˜¸ì¶œ
3. ì—ëŸ¬ ë°œìƒ ì‹œ ì´ì „ ìƒíƒœë¡œ ë¡¤ë°±
```

- ì‚¬ìš©ì ê²½í—˜ ê°œì„  (ë²„íŠ¼ í´ë¦­ ì¦‰ì‹œ ë°˜ì˜)
- ë„¤íŠ¸ì›Œí¬ ì§€ì—°ì—ë„ ë¹ ë¥¸ ë°˜ì‘

### **3. ìµœëŒ€ Depth ì œí•œ**

```typescript
const maxDepth = 2; // 0, 1, 2 (3ë‹¨ê³„)
const canReply = depth < maxDepth;
```

- ë¬´í•œ ì¤‘ì²© ë°©ì§€
- UI ê°€ë…ì„± ìœ ì§€

---

## ğŸ› **ë¬¸ì œ í•´ê²° (Troubleshooting)**

### **ë¬¸ì œ 1: "parent_id ì»¬ëŸ¼ì´ ì—†ìŠµë‹ˆë‹¤" ì—ëŸ¬**

**ì›ì¸**: Supabase ìŠ¤í‚¤ë§ˆê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.

**í•´ê²°**:
```sql
-- SQL Editorì—ì„œ ì‹¤í–‰:
ALTER TABLE comments ADD COLUMN IF NOT EXISTS parent_id UUID REFERENCES comments(id) ON DELETE CASCADE;
```

---

### **ë¬¸ì œ 2: "comment_likes í…Œì´ë¸”ì´ ì—†ìŠµë‹ˆë‹¤" ì—ëŸ¬**

**ì›ì¸**: `comment_likes` í…Œì´ë¸”ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.

**í•´ê²°**:
- `supabase_nested_comments.sql` íŒŒì¼ **ì „ì²´**ë¥¼ SQL Editorì—ì„œ ì‹¤í–‰í•˜ì„¸ìš”.

---

### **ë¬¸ì œ 3: ì¢‹ì•„ìš” ë²„íŠ¼ì„ ëˆŒëŸ¬ë„ ë°˜ì‘ì´ ì—†ìŠµë‹ˆë‹¤**

**ì›ì¸**: RLS ì •ì±…ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ê±°ë‚˜, ë¡œê·¸ì¸í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.

**í•´ê²°**:
1. ë¡œê·¸ì¸ ìƒíƒœì¸ì§€ í™•ì¸
2. Supabase Dashboard â†’ Authentication â†’ Policies í™•ì¸
3. `comment_likes` í…Œì´ë¸”ì˜ RLS ì •ì±… í™•ì¸

---

### **ë¬¸ì œ 4: ëŒ€ëŒ“ê¸€ì´ ì œëŒ€ë¡œ í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤**

**ì›ì¸**: `useComments` í›…ì˜ nested êµ¬ì¡° ë³€í™˜ ë¡œì§ì´ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.

**í•´ê²°**:
1. ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œ `ğŸ“Š Nested structure: X top-level, Y replies` ë¡œê·¸ í™•ì¸
2. ë¡œê·¸ê°€ ì—†ë‹¤ë©´ ì„œë²„ë¥¼ ì¬ì‹œì‘í•˜ì„¸ìš”:
   ```bash
   pkill -9 node && rm -rf .next && npm run dev
   ```

---

## ğŸ¨ **UI/UX íŠ¹ì§•**

### **ì¼ë³¸ ì»¤ë®¤ë‹ˆí‹° ëŠë‚Œ**
- íˆ¬ê³ ì íƒœê·¸: **[ä¸»]** (ìŠ¤ë ˆì£¼, ì¼ë³¸ ê²Œì‹œíŒ ìŠ¤íƒ€ì¼)
- ë‹µê¸€ ë²„íŠ¼: **"è¿”ä¿¡"**
- ì¢‹ì•„ìš” ë²„íŠ¼: **"ğŸ‘ ã„ã„ã­"**

### **ì‹œê°ì  ê³„ì¸µ êµ¬ì¡°**
- ëŒ€ëŒ“ê¸€ì€ `ml-8` (ì™¼ìª½ ì—¬ë°±)ìœ¼ë¡œ indent
- ìµœëŒ€ 3ë‹¨ê³„ ê¹Šì´ë¡œ ê°€ë…ì„± ìœ ì§€

### **ìƒ‰ìƒ**
- íˆ¬ê³ ì íƒœê·¸: íŒŒë€ìƒ‰ ë°°ê²½ + íŒŒë€ìƒ‰ í…Œë‘ë¦¬
- ì¢‹ì•„ìš” í™œì„±í™”: íŒŒë€ìƒ‰ ì•„ì´ì½˜ + ê¸€ì”¨
- ì‹œê°„ í‘œì‹œ: íšŒìƒ‰ í…ìŠ¤íŠ¸

---

## ğŸš€ **ë‹¤ìŒ ë‹¨ê³„ (ì„ íƒ ì‚¬í•­)**

### **1. ì•Œë¦¼ ê¸°ëŠ¥ ì—°ë™**
- ëŒ€ëŒ“ê¸€ì´ ë‹¬ë¦¬ë©´ ì› ëŒ“ê¸€ ì‘ì„±ìì—ê²Œ ì•Œë¦¼
- ëŒ“ê¸€ì— ì¢‹ì•„ìš”ê°€ ë‹¬ë¦¬ë©´ ëŒ“ê¸€ ì‘ì„±ìì—ê²Œ ì•Œë¦¼

### **2. ëŒ“ê¸€ ì •ë ¬ ì˜µì…˜**
- ìµœì‹ ìˆœ / ì¢‹ì•„ìš”ìˆœ / ë‹µê¸€ ë§ì€ ìˆœ

### **3. ëŒ“ê¸€ ìˆ˜ì •/ì‚­ì œ ê¸°ëŠ¥**
- ìì‹ ì˜ ëŒ“ê¸€ë§Œ ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥

---

## ğŸ“ **ì™„ë£Œ! ğŸ‰**

ëª¨ë“  ê¸°ëŠ¥ì´ ì„±ê³µì ìœ¼ë¡œ êµ¬í˜„ë˜ì—ˆìŠµë‹ˆë‹¤!

ë‹¤ìŒ ì‘ì—…ì„ ì‹œì‘í•˜ì„¸ìš”:
1. âœ… `supabase_nested_comments.sql` ì‹¤í–‰
2. âœ… ì„œë²„ ì¬ì‹œì‘ (`pkill -9 node && rm -rf .next && npm run dev`)
3. âœ… ê²Œì‹œê¸€ ìƒì„¸ í˜ì´ì§€ì—ì„œ í…ŒìŠ¤íŠ¸

**ë¬¸ì œê°€ ìˆìœ¼ë©´ ìœ„ì˜ "ë¬¸ì œ í•´ê²°" ì„¹ì…˜ì„ ì°¸ê³ í•˜ì„¸ìš”!** ğŸ˜Š
